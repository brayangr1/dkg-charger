<VirtualHost *:80>
    ServerName server.dkgsolutions.es
    ServerAdmin webmaster@dkgsolutions.es
    
    # Deshabilitar DocumentRoot para evitar conflicto
    DocumentRoot /var/www/server/
    
    # Habilitar módulos necesarios
    ProxyPreserveHost On
    ProxyRequests Off
    
    # Redirigir API calls a Node.js
    ProxyPass /api http://localhost:5010/api
    ProxyPassReverse /api http://localhost:5010/api
    
    # Redirigir todo el tráfico a Node.js (opcional)
    ProxyPass / http://localhost:5010/
    ProxyPassReverse / http://localhost:5010/
    
    # Headers CORS para Apache (Comentado para evitar duplicidad con Node.js)
    # Header always set Access-Control-Allow-Origin "*"
    # Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    # Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
    
    # Manejar preflight OPTIONS (Comentado para dejar que Node.js maneje CORS)
    # RewriteEngine On
    # RewriteCond %{REQUEST_METHOD} OPTIONS
    # RewriteRule ^(.*)$ $1 [R=200,L]
    
    ErrorLog ${APACHE_LOG_DIR}/server.dkgsolutions.es_error.log
    CustomLog ${APACHE_LOG_DIR}/server.dkgsolutions.es_access.log combined
RewriteCond %{SERVER_NAME} =server.dkgsolutions.es
RewriteRule ^ https://%{SERVER_NAME}%{REQUEST_URI} [END,NE,R=permanent]
</VirtualHost>

<IfModule mod_ssl.c>
<VirtualHost *:443>    
		ServerAdmin webmaster@dkgsolutions.es
    # DocumentRoot principal
    DocumentRoot /var/www/server/
  ServerName server.dkgsolutions.es
  ServerAlias server.dkgsolutions.es
    
  # Redirigir WebSocket -> rutas /ocpp al servicio OCPP en puerto 8887
  RewriteCond %{HTTP:Upgrade} websocket [NC]
  RewriteRule ^/ocpp(.*)$ ws://localhost:8887/ocpp$1 [P,L]
  
  # Redirigir WebSocket -> rutas /ws al servicio Node.js en puerto 5010
  RewriteCond %{HTTP:Upgrade} websocket [NC]
  RewriteRule ^/ws(.*)$ ws://localhost:5010/ws$1 [P,L]

    # Redirigir API calls a Node.js
    ProxyPass /api http://localhost:5010/api
    ProxyPassReverse /api http://localhost:5010/api
    
    # Redirigir todo el tráfico a Node.js (opcional)
    ProxyPass / http://localhost:5010/
    ProxyPassReverse / http://localhost:5010/
    
    # Headers CORS para Apache (Comentado para evitar duplicidad con Node.js)
    # Header always set Access-Control-Allow-Origin "*"
    # Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    # Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
    
    # Manejar preflight OPTIONS (Comentado para dejar que Node.js maneje CORS)
    # RewriteEngine On
    # RewriteCond %{REQUEST_METHOD} OPTIONS
    # RewriteRule ^(.*)$ $1 [R=200,L]
    
    # Configuracion del directorio principal
    <Directory /var/www/server/>
        Options -Indexes +FollowSymLinks +MultiViews
        AllowOverride All
        Require all granted
        
        # Priorizar archivos index
        DirectoryIndex index.html index.php
    </Directory>
Include /etc/letsencrypt/options-ssl-apache.conf
SSLCertificateFile /etc/letsencrypt/live/electroprime.es/fullchain.pem
SSLCertificateKeyFile /etc/letsencrypt/live/electroprime.es/privkey.pem

</VirtualHost>
</IfModule>
